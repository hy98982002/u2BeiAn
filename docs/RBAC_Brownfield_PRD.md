# UAI教育平台 RBAC权限系统 Brownfield增强PRD

## 项目分析和背景

### 现有项目概述

**分析来源**: IDE基础分析 + 现有文档分析

**当前项目状态**:
- **UAI教育平台** - Vue 3 + Django REST Framework全栈在线教育平台
- **核心功能**: AI+Logo设计教育，7层课程体系（体验→入门→精进→实战→项目落地→会员→就业）
- **商业模式**: "免费引流+付费转化+会员深度服务"
- **技术架构**: 前后端分离，Bootstrap 5.3.6 UI，Pinia状态管理，JWT认证

### 现有文档分析

**可用文档**:
- ✅ RBAC技术规范 - `/docs/RBAC_Technical_Specification.md`
- ✅ RBAC角色精简建议 - `/docs/RBAC角色调整建议.md`  
- ✅ PRD v6.0 (SEO/AEO) - `/docs/prd.md`
- ✅ PRD v7.0 (核心业务) - `/docs/core-business-prd-v7.md`
- ✅ 技术栈文档 - `CLAUDE.md`, `frontend/CLAUDE.md`
- ✅ API文档 - Django REST架构已建立
- ⚠️ 缺少RBAC业务需求文档 - 这正是我们要创建的

### 增强范围定义

**增强类型**: 
- [x] 新功能添加
- [x] 企业扩展架构预留

**增强描述**: 
为现有UAI教育平台添加基于角色的访问控制(RBAC)系统，支持精简的"2层6角色"架构，确保课程分层访问、会员权益管控和运营权限管理。同时预留企业客户扩展架构，支持未来无缝升级到企业级权限管理，包括组织隔离、席位管理和企业专属功能。

**影响评估**: 
- [x] 中等影响（需要在现有认证基础上添加权限层，但不改变核心业务逻辑）
- [x] 企业扩展影响（预留架构设计，当前不影响个人用户功能）

### 目标和背景上下文

**目标**:
• 实现7层课程体系的精细化权限控制，确保付费内容安全
• 建立清晰的运营角色边界，支持团队协作而不发生权限冲突
• 保护用户敏感数据，符合教育平台的合规要求
• 支持未来业务扩展，为多机构、多品牌预留架构空间

**背景上下文**:
当前UAI平台已具备基础JWT认证，但缺乏细粒度权限控制。随着7层课程体系和会员制度的建立，急需解决：1）免费用户vs付费会员的内容访问控制；2）运营团队内部的职责分工和权限边界；3）敏感数据的分级保护。基于专业建议，采用"先简后繁"的实施策略，从6个核心角色起步，避免过度设计。

**变更日志**:

| 变更 | 日期 | 版本 | 描述 | 作者 |
|------|------|------|------|------|
| 初始创建 | 2025-08-31 | 1.0 | 基于精简建议创建RBAC PRD | 产品经理约翰 |

## 需求规格

### 功能性需求

**FR1**: 系统必须支持"2层6角色"精简权限架构，包括后台层（Super Admin, Staff Admin, Staff Operator）和前台层（Premium Member, Registered User, Guest），替代原有的9角色复杂设计

**FR2**: 系统必须基于现有JWT认证扩展权限检查，在不破坏现有登录流程的前提下，为已认证用户添加角色权限验证

**FR3**: 系统必须实现7层课程体系的分级访问控制，确保体验课程（免费）→收费课程（需购买/会员）→会员课程（仅会员）→就业课程（单独购买）的权限边界

**FR4**: Staff Admin角色必须能管理教学内容全流程，整合原Platform Admin和Education Manager的职责，使用对象级权限区分业务线（如：仅能管理自己负责的课程分类）

**FR5**: Staff Operator角色必须统一运营、SEO、客服功能入口，通过动作级权限和ABAC条件细分具体操作权限（如：SEO专员仅能访问SEO相关功能模块）

**FR6**: 系统必须支持Django-guardian对象级权限，实现"讲师只能编辑自己创建的课程"等细粒度业务规则

**FR7**: 系统必须提供临时权限和审批流机制，支持"运营临时申请活动banner权限 → Super Admin审批 → 自动过期"的业务场景

**FR8**: 系统必须保持与现有Vue 3前端的完全兼容，通过Composables和指令实现权限控制，不影响现有组件和页面

### 企业扩展预留需求

**ER1**: 数据模型必须支持未来企业角色无缝插入，Role表使用`slug`字段（如`enterprise_member`）和`level`序号预留，Subscription表增加`seat_quota`、`org_id`、`membership_type`字段支持企业订阅

**ER2**: RBACService必须提供扩展点接口，支持未来按`org_id`过滤权限的企业级数据隔离，当前实现为直通逻辑

**ER3**: 权限系统必须支持ABAC（属性驱动访问控制），当`subscription.membership_type == 'enterprise'`时触发企业专属逻辑（如席位检查），但MVP阶段暂不实现

**ER4**: Premium Member角色必须兼容企业订阅类型，通过订阅系统区分个人会员和企业会员，权限范围保持一致但计费和席位管理不同

**ER5**: 系统必须支持Feature Flag机制，控制企业相关功能的显示和启用，确保MVP阶段企业功能完全隐藏

### 非功能性需求

**NFR1**: 权限检查响应时间必须<100ms，通过Redis缓存优化确保不影响现有页面加载性能

**NFR2**: 系统必须支持现有SQLite开发环境和未来MySQL生产环境的数据库兼容性，权限数据迁移零停机

**NFR3**: RBAC系统必须支持现有Bootstrap 5.3.6 UI框架的权限控制组件，保持视觉一致性

**NFR4**: 系统扩展必须遵循现有Pinia状态管理模式，权限状态与现有用户状态无缝集成

**NFR5**: 权限系统必须支持现有CI/CD部署流程（Vercel前端 + Railway后端），无需额外部署配置

### 兼容性需求

**CR1**: **现有API兼容性** - 所有现有API端点必须保持响应格式不变，权限验证作为中间件透明添加，现有前端调用无需修改

**CR2**: **数据库schema兼容性** - 新增的RBAC表（roles, permissions, user_roles等）必须与现有用户表通过外键关联，不修改现有表结构

**CR3**: **UI/UX一致性** - 权限控制UI组件必须复用现有Bootstrap样式和设计模式，权限拒绝提示与现有错误提示保持视觉统一

**CR4**: **集成兼容性** - RBAC系统必须与现有阿里云短信、微信登录等第三方集成保持兼容，不影响现有认证流程

## 用户界面增强目标

### 与现有UI集成

**设计一致性**: RBAC权限控制组件将完全复用UAI平台现有的Bootstrap 5.3.6设计系统，包括：
- 按钮样式和交互状态与现有设计保持一致
- 表单组件使用现有的输入框、选择器、开关样式
- 弹窗和提示使用现有的Modal和Alert组件
- 图标库使用现有的Bootstrap Icons

**权限控制集成**: 新增权限相关UI元素将无缝集成到现有页面：
- 导航菜单根据用户权限动态显示/隐藏菜单项
- 操作按钮基于权限显示或禁用状态
- 页面内容区域根据访问权限展示相应内容或权限提示

### 修改/新增界面列表

**后台管理界面**（新增）:
- 角色管理页面 - 6个核心角色的创建、编辑、权限配置
- 用户权限管理页面 - 用户角色分配、临时权限授予
- 权限审批页面 - 临时权限申请的审批工作流

**现有界面增强**:
- 课程管理页面 - 增加基于角色的操作权限控制
- 用户中心页面 - 增加会员权限状态显示
- 内容管理页面 - 根据Staff Operator细分权限显示功能模块

### UI一致性需求

**视觉一致性**: 
- 权限相关的所有新增页面必须使用UAI平台标准的页面布局模板
- 颜色方案、字体、间距严格遵循现有设计规范
- 权限提示和错误信息使用统一的提示样式和文案风格

**交互一致性**:
- 权限控制的用户操作流程与现有功能操作保持一致的交互模式
- 表单验证、提交反馈、加载状态与现有组件行为保持统一
- 键盘导航和无障碍访问遵循现有标准

## 技术约束和集成需求

### 现有技术栈

**语言**: Python 3.12, JavaScript ES6+, TypeScript 4.x
**框架**: Django 5.2, Vue 3 (Composition API), Django REST Framework
**数据库**: MySQL 8.4+(开发), MySQL 8.4+ (生产)
**基础设施**: Vercel (前端), Railway (后端), Redis (缓存)
**外部依赖**: 阿里云短信服务, 微信OAuth, Bootstrap 5.3.6

### 集成策略

**数据库集成策略**: 
- 使用Django migrations无缝添加RBAC相关表
- 通过外键关联现有User表，保持数据完整性
- 支持SQLite→MySQL的平滑迁移路径

**API集成策略**: 
- 使用Django middleware在现有API层添加权限检查
- 保持现有API响应格式`{status, data, msg}`不变
- 权限验证失败返回标准403响应格式

**前端集成策略**: 
- 扩展现有Pinia用户store添加权限状态管理
- 创建Vue 3 Composables提供权限检查hooks
- 使用Vue指令实现声明式权限控制

**测试集成策略**: 
- 扩展现有测试框架添加权限相关测试用例
- 确保现有功能测试在添加权限后仍然通过
- 增加权限边界测试和安全测试

### 代码组织和标准

**文件结构方法**: 
```
backend/apps/rbac/          # 新增RBAC应用
├── models.py              # 角色、权限数据模型（含企业扩展字段）
├── views.py               # 权限管理API视图
├── permissions.py         # 权限检查逻辑
├── middleware.py          # 权限验证中间件
├── serializers.py         # API序列化器
├── services.py            # RBACService（含企业扩展点）
└── enterprise.py          # 企业权限扩展逻辑（MVP阶段空实现）

frontend/src/
├── composables/useRBAC.ts # 权限检查Composables
├── components/rbac/       # 权限控制组件
├── store/rbacStore.ts     # 权限状态管理
├── directives/rbac.ts     # 权限指令
└── components/enterprise/ # 企业管理组件（Feature Flag控制）
```

**命名约定**: 
- 遵循现有Django和Vue命名规范
- RBAC相关类和函数使用描述性命名
- 权限常量使用大写下划线格式

**编码标准**: 
- 后端遵循PEP 8 Python编码规范
- 前端遵循现有ESLint和Prettier配置
- 类型定义使用TypeScript严格模式

**文档标准**: 
- 所有RBAC相关API提供OpenAPI文档
- 关键权限逻辑添加详细代码注释
- 用户操作手册和技术文档使用Markdown格式

### 部署和运维

**构建流程集成**: 
- RBAC功能集成到现有的CI/CD pipeline
- 数据库迁移脚本自动化执行
- 前后端代码同步部署确保兼容性

**部署策略**: 
- 采用蓝绿部署避免权限系统升级停机
- 数据库迁移使用滚动更新策略
- Redis权限缓存预热确保性能

**监控和日志**: 
- 集成现有日志系统记录权限相关操作
- 添加权限检查性能监控指标
- 权限异常和安全事件告警机制

**配置管理**: 
- 权限相关配置使用环境变量管理
- 敏感配置（如Redis连接）使用加密存储
- 支持不同环境的权限配置差异

### 风险评估和缓解

**技术风险**:
- 权限检查可能影响API响应性能 → 使用Redis缓存和异步处理缓解
- 复杂权限逻辑可能引入bug → 完善测试覆盖和代码审查
- 数据库迁移可能影响现有数据 → 完整备份和回滚机制

**集成风险**:
- 新权限系统可能与现有功能冲突 → 渐进式集成和充分测试
- 前后端权限状态同步问题 → 统一权限检查接口和缓存策略
- 第三方集成兼容性问题 → 保持现有认证流程不变

**部署风险**:
- 权限系统升级可能导致服务中断 → 蓝绿部署和平滑切换
- Redis缓存故障影响权限检查 → 降级到数据库直接查询机制
- 数据库性能在权限检查负载下下降 → 索引优化和查询优化

**缓解策略**:
- 全面的自动化测试覆盖权限相关功能
- 权限系统性能基准测试和监控
- 详细的回滚计划和应急响应机制
- 团队权限管理培训和操作文档

## Epic和Story结构

### Epic方法

**Epic结构决策**: 单一综合Epic - 考虑到RBAC是一个内聚的功能模块，所有组件需要协调工作，采用单一Epic方式更有利于保证各部分的一致性和集成质量。

## Epic 1: UAI平台RBAC权限系统

**Epic目标**: 为UAI教育平台实施基于"2层6角色"架构的RBAC权限管理系统，确保7层课程体系的访问控制、团队协作权限边界和数据安全保护，同时保持100%现有功能兼容性。

**集成需求**: 在现有JWT认证基础上无缝添加角色权限层，通过Django middleware和Vue Composables实现透明权限控制，不影响现有用户体验和系统性能。

### Story 1.1: 建立RBAC数据模型和基础服务

As a **系统架构师**,
I want **创建RBAC核心数据模型和权限检查服务**,
so that **为整个权限系统提供稳固的数据基础和核心业务逻辑**。

**验收标准**:
1. Django RBAC app创建完成，包含Role、Permission、UserRole、RolePermission模型
2. 6个核心角色的初始数据迁移脚本可正常执行
3. RBACService权限检查核心逻辑实现并通过单元测试
4. Redis缓存集成完成，权限检查响应时间<100ms
5. 数据库索引优化，支持高并发权限查询
6. 数据模型支持企业扩展字段（org_id, seat_quota, membership_type），Migration脚本包含预留字段但暂不启用
7. RBACService.get_scope()方法提供组织过滤扩展点，当前返回全局范围
8. Feature Flag系统就位，企业相关功能可通过配置控制显示

**集成验证**:
- IV1: 现有用户表与新RBAC表外键关联正确，数据完整性约束正常
- IV2: 现有认证流程不受影响，JWT token解析和用户状态获取正常
- IV3: SQLite开发环境和MySQL生产环境数据模型兼容性验证通过

### Story 1.2: 实现后端权限中间件和API集成

As a **后端开发者**,
I want **在现有API层透明添加权限验证中间件**,
so that **所有API调用都能进行权限检查，同时不破坏现有接口契约**。

**验收标准**:
1. Django权限验证中间件实现，支持基于路径和方法的权限检查
2. 权限装饰器可应用到现有ViewSet，支持对象级权限控制
3. API响应格式保持现有`{status, data, msg}`结构不变
4. 权限拒绝返回标准403响应，错误信息格式统一
5. 临时权限和审批流机制基础功能实现

**集成验证**:
- IV1: 现有所有API端点在添加权限检查后功能正常，响应格式不变
- IV2: 超级管理员能正常访问所有功能，权限检查逻辑正确
- IV3: 不同角色用户权限边界验证正确，无权限泄露或过度限制

### Story 1.3: 开发前端权限控制组件和状态管理

As a **前端开发者**,
I want **创建Vue 3权限控制组件和Composables**,
so that **前端页面能根据用户权限动态显示内容和控制操作**。

**验收标准**:
1. useRBAC Composables实现，提供权限检查、角色判断等功能
2. PermissionGate和RoleGate组件支持声明式权限控制
3. Vue权限指令(v-permission, v-role)可正常使用
4. Pinia RBAC store与现有用户store无缝集成
5. 权限状态缓存和自动刷新机制工作正常

**集成验证**:
- IV1: 现有Vue组件集成权限控制后渲染正常，无样式和功能冲突
- IV2: Bootstrap 5.3.6样式在权限控制组件中正确应用
- IV3: 权限变化时前端状态同步及时，用户体验流畅

### Story 1.4: 实现7层课程体系权限控制

As a **教育产品运营**,
I want **不同角色用户能按照权限访问对应层级的课程内容**,
so that **付费内容得到保护，免费内容能有效引流，会员价值得到体现**。

**验收标准**:
1. 体验课程对所有用户（包括Guest）开放访问
2. 收费课程仅对已购买用户和Premium Member开放
3. 会员课程仅对Premium Member开放
4. 就业课程需要单独购买，独立于会员权益
5. Staff角色能根据职责访问相应的课程管理功能

**集成验证**:
- IV1: 现有课程页面在不同用户登录状态下显示正确的访问控制
- IV2: 课程购买流程与权限验证无缝集成，购买后立即获得访问权限
- IV3: 会员订阅/取消后权限状态实时更新，课程访问权限正确变化

### Story 1.5: 开发权限管理后台界面

As a **平台管理员**,
I want **通过可视化界面管理用户角色和权限配置**,
so that **能够高效地进行权限分配、角色管理和权限审批操作**。

**验收标准**:
1. 角色管理页面支持6个核心角色的查看和权限配置
2. 用户权限管理页面支持角色分配和批量操作
3. 临时权限审批工作流界面完整可用
4. 权限变更日志和审计功能正常工作
5. 所有管理界面遵循UAI平台UI设计规范

**集成验证**:
- IV1: 管理后台界面与现有Django admin和前端管理页面风格一致
- IV2: 权限配置变更后立即生效，无需系统重启
- IV3: 管理操作的权限控制正确，非授权用户无法访问管理功能

### Story 1.6: 权限系统测试和性能优化

As a **质量保证工程师**,
I want **完整的权限系统测试覆盖和性能基准验证**,
so that **确保权限系统稳定可靠，不影响平台整体性能**。

**验收标准**:
1. 单元测试覆盖率>90%，集成测试覆盖所有权限场景
2. 权限检查性能基准测试通过，响应时间<100ms
3. 并发权限验证压力测试通过，系统稳定性良好
4. 安全渗透测试通过，无权限绕过漏洞
5. 现有功能回归测试100%通过

**集成验证**:
- IV1: 在权限系统全量部署后，现有所有功能保持正常运行
- IV2: 系统整体性能指标未受权限检查影响，页面加载时间保持在可接受范围
- IV3: 用户体验测试通过，权限控制对用户透明且直观

---

## 实施时间表

### MVP阶段实施计划

**Phase 1 (Week 1-2)**: Story 1.1-1.3 - 基础架构和核心功能（含企业架构预留）
**Phase 2 (Week 3-4)**: Story 1.4-1.5 - 业务集成和管理界面  
**Phase 3 (Week 5-6)**: Story 1.6 - 测试优化和上线准备

**关键里程碑**:
- Week 2: 基础RBAC功能可用，6角色权限验证正常，企业扩展架构预留完成
- Week 4: 7层课程权限控制完成，管理界面可用
- Week 6: 系统全面测试通过，生产环境就绪

### 企业扩展实施规划

**企业版触发条件统一标准**:
- 月付费用户数 > 500人
- 企业主动咨询数 >= 3家
- 个人会员续费率 > 60%

**阶段2 (市场验证)**: 1-2周
- 企业客户需求调研和竞争分析
- MVP企业版功能启用（基于预留架构）
- 2-3家试点企业验证

**阶段3 (企业版上线)**: 3-4周  
- 新增Enterprise Admin角色
- 席位管理和企业后台开发
- 批量购买和企业计费系统

**成功指标**:
- 权限检查性能<100ms ✓
- 现有功能100%兼容 ✓  
- 用户权限管理效率提升70% ✓
- 安全漏洞数量 = 0 ✓
- 团队权限配置时间从2小时缩短至15分钟 ✓
- 企业扩展实施时间<1周（基于预留架构）✓